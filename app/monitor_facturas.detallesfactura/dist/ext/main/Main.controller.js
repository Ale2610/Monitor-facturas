sap.ui.define(["sap/fe/core/PageController","sap/m/MessageToast"],function(e,t){"use strict";return e.extend("monitorfacturas.detallesfactura.ext.main.Main",{onInit:function(){const e=this.byId("FacturaList");e.attachEventOnce("updateFinished",()=>{this._aplicarFiltrosDesdeHash()})},_aplicarFiltrosDesdeHash:function(){const e=window.location.hash;const t=this._getQueryParamFromHash("Estado",e);const o=this._getQueryParamFromHash("urgente",e);const n=[];if(t){n.push(new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,t));this.byId("filtroEstado").setSelectedKey(t)}if(o){n.push(new sap.ui.model.Filter("Urgente",sap.ui.model.FilterOperator.EQ,o));this.byId("filtroUrgente").setSelectedKey(o)}const a=this.byId("FacturaList").getBinding("items");if(a){a.filter(n)}else{console.warn("El binding de la lista a√∫n no est√° disponible.")}},_getQueryParamFromHash:function(e,t){const o=t.split("?")[1];if(!o)return null;const n=new URLSearchParams(o);return n.get(e)},onDetallePress:function(e){e.preventDefault();e.cancelBubble=true;var t=e.getSource();var o=t.getParent();var n=o.getBindingContext();var a=n.getProperty("NumeroFactura");var r="monitorfacturasdetallesfactura-display&/Facturas('"+a+"')";if(window.self!==window.top){window.location.hash=r}else{window.location.href="launchpadPage.html#"+r}},formatter:{estadoToState:function(e){if(e==="Aprobado"){return"Success"}else if(e==="Rechazado"){return"Error"}else{return"Warning"}},urgenteToState:function(e){return e?"Error":"Success"},urgenteToText:function(e){return e?"S√≠":"No"}},timeUTC:function(){var e=new Date;var t=new Date(e.getTime()-e.getTimezoneOffset()*6e4);t.setHours(t.getHours()+5);console.log(t.toISOString());return t.toISOString()},createdNonce:function(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;const o=e==="x"?t:t&3|8;return o.toString(16)});console.log(e);var t=btoa(e);return t},getInvoicesList:async function(){var e=this.timeUTC();var o=this.createdNonce();try{const n=await fetch("/service/Monitor_FacturasService/consultar_documentos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({noce:o,created:e})});const a=await n.text();console.log("Respuesta SOAP:",a);const r=a.match(/<availableDocument>[\s\S]*?<\/availableDocument>/g);const i=[];if(r&&r.length>0){r.forEach(e=>{const t=e.match(/<documentNumber>(.*?)<\/documentNumber>/)?.[1]||"";const o=e.match(/<documentPrefix>(.*?)<\/documentPrefix>/)?.[1]||"";const n=e.match(/<documentType>(.*?)<\/documentType>/)?.[1]||"";const a=e.match(/<senderIdentification>(.*?)<\/senderIdentification>/)?.[1]||"";i.push({documentNumber:t,documentPrefix:o,documentType:n,senderIdentification:a})})}console.log("üìã Documentos extra√≠dos:",i);t.show(`Consulta realizada. ${i.length} documentos disponibles.`);return i}catch(e){console.error("Error al consultar:",e);t.show("Error en consulta SOAP");return[]}},getDocuments:async function(){var e=await this.getInvoicesList();for(const n of e){var t=this.timeUTC();var o=this.createdNonce();console.log("N√∫mero de documento:",n.documentNumber);console.log("Prefijo de documento:",n.documentPrefix);console.log("Tipo de documento:",n.documentType);console.log("Identificaci√≥n del remitente:",n.senderIdentification);try{const e=await fetch("/service/Monitor_FacturasService/extraer_documentos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({noce:o,created:t,data:"SIGNED_XML",documentNumber:n.documentNumber,documentPrefix:n.documentPrefix,documentType:n.documentType,senderIdentification:n.senderIdentification})});const a=await e.text();console.log("Respuesta SOAP:",a);await this.extraerFactura(a)}catch(e){console.error("‚ùå Error al extraer documentos:",e)}}},extraerFactura:async function(e){try{const t=atob(e);console.log("XML decodificado:",t)}catch(e){console.error("Error al decodificar el XML:",e)}},insertarFactura:async function(e){var t={FechaContabilizacion:"2025-04-28",FechaFactura:"2025-04-28",FechaVencimiento:"2025-05-28",FechaRecepcion:"2025-04-27",FormaPago:"Contado",NumeroFactura:"FAC-123456",Proveedor:{CodigoSap:"CodigoSap8014"},Posiciones:"1,2,3",TotalFactura:"1000",ValorFinal:"950",IVA:"50",IndicadorImpuesto:"IVA19",NumeroIndicador:"1234",Destinatario:"Centro Principal",DescripcionDestinatario:"Sede Norte",CodigoActividad:"123ABC",Clasificacion:"Servicios",Estado:"Pendiente",Urgente:false,Area:"Compras",Sede:"Bogot√°",Comentario:"Factura correspondiente a servicios de abril",DocumentoMIRO:"",DocumentoFI:"",FacturaElec:true,Descuento:false,archivoPDF:null};console.log("Inserci√≥n de factura en proceso...");try{await fetch("/service/Monitor_FacturasService/Facturas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});console.log("Factura insertada exitosamente")}catch(e){console.error("Error al insertar la factura:",e)}},onBuscarFactura:function(e){const t=e.getParameter("query");this._aplicarFiltros(t)},onFiltrarEstadoUrgente:function(){const e=this.byId("searchFactura").getValue();this._aplicarFiltros(e)},_aplicarFiltros:function(e){const t=this.byId("filtroEstado").getSelectedKey();const o=this.byId("filtroUrgente").getSelectedKey();const n=[];if(e){n.push(new sap.ui.model.Filter("NumeroFactura",sap.ui.model.FilterOperator.Contains,e))}if(t){n.push(new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,t))}if(o){n.push(new sap.ui.model.Filter("Urgente",sap.ui.model.FilterOperator.EQ,o))}const a=this.byId("FacturaList");const r=a.getBinding("items");if(r){r.filter(n)}else{console.warn("No se encontr√≥ el binding de la lista")}}})});
//# sourceMappingURL=Main.controller.js.map