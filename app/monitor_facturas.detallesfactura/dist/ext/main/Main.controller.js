sap.ui.define(["sap/fe/core/PageController","sap/m/MessageToast"],function(e,t){"use strict";return e.extend("monitorfacturas.detallesfactura.ext.main.Main",{onInit:function(){const e=this.byId("FacturaList");e.attachEventOnce("updateFinished",()=>{this._aplicarFiltrosDesdeHash()});sap.ui.getCore().getEventBus().subscribe("Facturas","ActualizarLista",this._onActualizarLista,this)},_aplicarFiltrosDesdeHash:function(){const e=window.location.hash;const t=this._getQueryParamFromHash("Estado",e);const a=this._getQueryParamFromHash("urgente",e);const o=[];if(t){o.push(new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,t));this.byId("filtroEstado").setSelectedKey(t)}if(a){o.push(new sap.ui.model.Filter("Urgente",sap.ui.model.FilterOperator.EQ,a));this.byId("filtroUrgente").setSelectedKey(a)}const c=this.byId("FacturaList").getBinding("items");if(c){c.filter(o)}else{console.warn("El binding de la lista a√∫n no est√° disponible.")}},_getQueryParamFromHash:function(e,t){const a=t.split("?")[1];if(!a)return null;const o=new URLSearchParams(a);return o.get(e)},_onActualizarLista:function(){const e=this.byId("FacturaList");const t=e.getBinding("items");if(t){t.refresh()}},onDetallePress:function(e){e.preventDefault();e.cancelBubble=true;var t=e.getSource();var a=t.getParent();var o=a.getBindingContext();var c=o.getProperty("NumeroFactura");var n="monitorfacturasdetallesfactura-display&/Facturas('"+c+"')";if(window.self!==window.top){window.location.hash=n}else{window.location.href="launchpadPage.html#"+n}},formatter:{estadoToState:function(e){if(e==="Aprobado"){return"Success"}else if(e==="Rechazado"){return"Error"}else{return"Warning"}},urgenteToState:function(e){return e?"Error":"Success"},urgenteToText:function(e){return e?"S√≠":"No"}},timeUTC:function(){var e=new Date;var t=new Date(e.getTime()-e.getTimezoneOffset()*6e4);t.setHours(t.getHours()+5);console.log(t.toISOString());return t.toISOString()},createdNonce:function(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;const a=e==="x"?t:t&3|8;return a.toString(16)});console.log(e);var t=btoa(e);return t},getInvoicesList:async function(){var e=this.timeUTC();var a=this.createdNonce();try{const o=await fetch("/service/Monitor_FacturasService/consultar_documentos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({noce:a,created:e})});const c=await o.text();console.log("Respuesta SOAP:",c);const n=c.match(/<availableDocument>[\s\S]*?<\/availableDocument>/g);const r=[];if(n&&n.length>0){n.forEach(e=>{const t=e.match(/<documentNumber>(.*?)<\/documentNumber>/)?.[1]||"";const a=e.match(/<documentPrefix>(.*?)<\/documentPrefix>/)?.[1]||"";const o=e.match(/<documentType>(.*?)<\/documentType>/)?.[1]||"";const c=e.match(/<senderIdentification>(.*?)<\/senderIdentification>/)?.[1]||"";r.push({documentNumber:t,documentPrefix:a,documentType:o,senderIdentification:c})})}console.log("üìã Documentos extra√≠dos:",r);t.show(`Consulta realizada. ${r.length} documentos disponibles.`);return r}catch(e){console.error("Error al consultar:",e);t.show("Error en consulta SOAP");return[]}},getDocuments:async function(){var e=await this.getInvoicesList();for(const o of e){var t=this.timeUTC();var a=this.createdNonce();console.log("Identificaci√≥n del remitente:",o.senderIdentification);try{const e=await fetch("/service/Monitor_FacturasService/extraer_documentos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({noce:a,created:t,data:"SIGNED_XML",documentNumber:o.documentNumber,documentPrefix:o.documentPrefix,documentType:o.documentType,senderIdentification:o.senderIdentification})});const c=await e.text();const n=c.match(/<downloadData>([\s\S]*?)<\/downloadData>/);const r=n?.[1]||"";console.log("üì¶ Contenido base64 de downloadData:",r);await this.extraerFactura(r)}catch(e){console.error("‚ùå Error al extraer documentos:",e)}}},extraerFactura:async function(e){try{const o=atob(e);console.log("XML decodificado:",o);const c=/<cac:InvoiceLine[^>]*>([\s\S]*?)<\/cac:InvoiceLine>/g;let n;const r=[];while((n=c.exec(o))!==null){const e=n[1];const t=e.match(/<cbc:ID[^>]*>(.*?)<\/cbc:ID>/)?.[1]||"Desconocido";const a=e.match(/<cbc:InvoicedQuantity[^>]*>(.*?)<\/cbc:InvoicedQuantity>/)?.[1]||"0";const c=e.match(/<cbc:LineExtensionAmount[^>]*>(.*?)<\/cbc:LineExtensionAmount>/)?.[1]||"0";const i=e.match(/<cbc:PriceAmount[^>]*>(.*?)<\/cbc:PriceAmount>/)?.[1]||"0";const s=e.match(/<cbc:Description[^>]*>(.*?)<\/cbc:Description>/)?.[1]||"Sin descripci√≥n";const u=o.match(/<cbc:ParentDocumentID>(.*?)<\/cbc:ParentDocumentID>/)?.[1]||"";r.push({NumeroMaterial:t,Descripcion:s,Cantidad:a,ValorUnitario:i,ValorTotal:c,NumeroFactura_NumeroFactura:u})}console.log("detalles ",r);const i={FechaContabilizacion:o.match(/<cbc:IssueDate>(.*?)<\/cbc:IssueDate>/)?.[1]||"",FechaFactura:o.match(/<cbc:IssueDate>(.*?)<\/cbc:IssueDate>/)?.[1]||"",FechaVencimiento:o.match(/<cbc:DueDate>(.*?)<\/cbc:DueDate>/)?.[1]||"",FechaRecepcion:"2025-04-27",FormaPago:"",NumeroFactura:o.match(/<cbc:ParentDocumentID>(.*?)<\/cbc:ParentDocumentID>/)?.[1]||"",Proveedor:{CodigoSap:o.match(/<cbc:CompanyID[^>]*schemeID="1"[^>]*>(\d{9,10})<\/cbc:CompanyID>/)?.[1]||""},Posiciones:o.match(/<cbc:LineCountNumeric>(\d+)<\/cbc:LineCountNumeric>/)?.[1]||"",TotalFactura:o.match(/<cbc:PayableAmount currencyID="COP">(.*?)<\/cbc:PayableAmount>/)?.[1]||"",ValorFinal:o.match(/<cbc:PayableAmount currencyID="COP">(.*?)<\/cbc:PayableAmount>/)?.[1]||"",IVA:o.match(/<cbc:TaxAmount currencyID="COP">(.*?)<\/cbc:TaxAmount>/)?.[1]||"",IndicadorImpuesto:o.match(/<cbc:Name>(.*?)<\/cbc:Name>/)?.[1]||"",NumeroIndicador:"",Destinatario:o.match(/<cac:ReceiverParty>[\s\S]*?<cbc:CompanyID.*?>(\d+)<\/cbc:CompanyID>/)?.[1]||"",DescripcionDestinatario:o.match(/<cac:ReceiverParty>[\s\S]*?<cbc:RegistrationName>(.*?)<\/cbc:RegistrationName>/)?.[1]||"",CodigoActividad:"",Clasificacion:"",Estado:"Central Facturas",Urgente:false,Area:"",Sede:"",Comentario:"Entrada",DocumentoMIRO:"",DocumentoFI:"",FacturaElec:true,Descuento:false,archivoPDF:null};console.log("Factura extra√≠da:",i);var t=await this.insertarFactura(i);var a=await this.insertarDetalleFacturas(r);return i}catch(e){console.error("Error al procesar el XML:",e)}},insertarFactura:async function(e){console.log("Inserci√≥n de factura en proceso...");try{await fetch("/service/Monitor_FacturasService/Facturas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("Factura insertada exitosamente")}catch(e){console.error("Error al insertar la factura:",e)}},insertarDetalleFacturas:async function(e){console.log("Inserci√≥n de detalles de factura en proceso...");for(let t=0;t<e.length;t++){const a=e[t];try{const e=await fetch("/service/Monitor_FacturasService/DetalleFactura",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok){console.error(`Error al insertar detalle #${t+1}:`,await e.text())}else{console.log(`Detalle #${t+1} insertado exitosamente`)}}catch(e){console.error(`Error al insertar detalle #${t+1}:`,e)}}console.log("Inserci√≥n de detalles completada.")},onBuscarFactura:function(e){const t=e.getParameter("query");this._aplicarFiltros(t)},onFiltrarEstadoUrgente:function(){const e=this.byId("searchFactura").getValue();this._aplicarFiltros(e)},_aplicarFiltros:function(e){const t=this.byId("filtroEstado").getSelectedKey();const a=this.byId("filtroUrgente").getSelectedKey();const o=[];if(e){o.push(new sap.ui.model.Filter("NumeroFactura",sap.ui.model.FilterOperator.Contains,e))}if(t){o.push(new sap.ui.model.Filter("Estado",sap.ui.model.FilterOperator.EQ,t))}if(a){o.push(new sap.ui.model.Filter("Urgente",sap.ui.model.FilterOperator.EQ,a))}const c=this.byId("FacturaList");const n=c.getBinding("items");if(n){n.filter(o)}else{console.warn("No se encontr√≥ el binding de la lista")}}})});
//# sourceMappingURL=Main.controller.js.map