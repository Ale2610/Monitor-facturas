<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monitor Facturas - Launchpad</title>
    <style>
        #appFrame {
            width: 100%;
            height: 600px;
            border: none;
            margin-top: 20px;
        }
    </style>
    <script src="https://ui5.sap.com/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m, sap.ui.layout"
        data-sap-ui-xx-bindingSyntax="complex">
    </script>
    <script>
        // Cargar la config de aplicaciones
        window["sap-ushell-config"] = {
            defaultRenderer: "fiori2",
            applications: {
                "monitorfacturasdetalleorden-display": {
                    title: "Detalle Orden",
                    url: "./monitor_facturas.detalleorden/webapp"
                },
                "monitorfacturasdetallesfactura-display": {
                    title: "Facturas",
                    url: "./monitor_facturas.detallesfactura/webapp/index.html"
                },
                "monitorfacturasentradas-display": {
                    title: "Entradas",
                    url: "./monitor_facturas.entradas/webapp"
                },
                "monitorfacturasfacturaorden-display": {
                    title: "Factura Orden",
                    url: "./monitor_facturas.facturaorden/webapp"
                },
                "monitorfacturasfacturasxml-display": {
                    title: "Facturas XML",
                    url: "./monitor_facturas.facturasxml/webapp"
                },
                "monitorfacturasmonitorfacturas-display": {
                    title: "Monitor Facturas",
                    url: "./monitor_facturas.monitorfacturas/webapp"
                },
                "monitorfacturasordendecompra-display": {
                    title: "Orden de Compra",
                    url: "./monitor_facturas.ordendecompra/webapp"
                },
                "monitorfacturasproveedores-display": {
                    title: "Proveedores",
                    url: "./monitor_facturas.proveedores/webapp"
                },
                "monitorfacturasbandejaentradaa-display": {
                    title: "Bandeja Entrada Almacenista",
                    url: "../lcapMonitor_Facturas.monitorfacturasbandejaentradaalmacenista-0.0.1"
                },
                "monitorfacturasbandejaentradab-display": {
                    title: "Bandeja Entrada BOT",
                    url: "../lcapMonitor_Facturas.monitorfacturasbandejaentradabot-0.0.1"
                },
                
                "monitorfacturasbandejaentradac-display": {
                    title: "Bandeja Entrada Contabilidad",
                    url: "../lcapMonitor_Facturas.monitorfacturasbandejaentradacontabilidad-0.0.1"
                },
                
                "monitorfacturascompradorbandej-display": {
                    title: "Comprador Bandeja Entrada",
                    url: "../lcapMonitor_Facturas.monitorfacturascompradorbandejaentrada-0.0.1"
                },
            }
        };
        function createTile(title, appId) {
    return new sap.m.GenericTile({
        header: title,
        press: function () {
            const app = window["sap-ushell-config"].applications[appId];
            if (app && app.url) {
                window.open(app.url, "_blank"); // ⬅️ Esto abre en otra pestaña
            } else {
                alert("No se encontró la aplicación para: " + appId);
            }
        },
        tileContent: [
            new sap.m.TileContent({
                content: new sap.ui.core.Icon({ src: "sap-icon://document" })
            })
        ]
    });
}


        sap.ui.getCore().attachInit(function () {
                    // Obtener roles del usuario
                    var request = new XMLHttpRequest();
                    request.open('GET', '/service/Monitor_FacturasService/getRoles', true);
                    request.send(null);

                    let roles = [];
                    if (request.status === 200) {
                        roles = JSON.parse(request.responseText).value;
                    }

                    let tabItems = [];

                    // Central para todos
                    tabItems.push(new sap.m.IconTabFilter({
                        text: "Central Facturas",
                        content: [
                            new sap.ui.layout.Grid({
                                defaultSpan: "L3 M6 S12",
                                content: [
                                    createTile("Facturas", "monitorfacturasdetallesfactura-display")
                                ]
                            })
                        ]
                    }));

                    // Rol: Comprador
                    if (roles.includes("Comprador")) {
                        tabItems.push(new sap.m.IconTabFilter({
                            text: "Comprador",
                            content: [
                                new sap.ui.layout.Grid({
                                    defaultSpan: "L3 M6 S12",
                                    content: [
                                        createTile("Comprador", "monitorfacturascompradorbandej-display")
                                    ]
                                })
                            ]
                        }));
                    }

                    // Rol: Almacenista
                    if (roles.includes("Almacenista")) {
                        tabItems.push(new sap.m.IconTabFilter({
                            text: "Almacenista",
                            content: [
                                new sap.ui.layout.Grid({
                                    defaultSpan: "L3 M6 S12",
                                    content: [
                                        createTile("Almacenista", "monitorfacturasbandejaentradaa-display")
                                    ]
                                })
                            ]
                        }));
                    }

                    // Rol: BOT
                    if (roles.includes("BOT")) {
                        tabItems.push(new sap.m.IconTabFilter({
                            text: "Gestión BOT",
                            content: [
                                new sap.ui.layout.Grid({
                                    defaultSpan: "L3 M6 S12",
                                    content: [
                                        createTile("Gestión BOT", "monitorfacturasbandejaentradab-display")
                                    ]
                                })
                            ]
                        }));
                    }

                    // Rol: Contabilidad
                    if (roles.includes("Contabilidad")) {
                        tabItems.push(new sap.m.IconTabFilter({
                            text: "Contabilización",
                            content: [
                                new sap.ui.layout.Grid({
                                    defaultSpan: "L3 M6 S12",
                                    content: [
                                        createTile("Contabilización", "monitorfacturasbandejaentradac-display")
                                    ]
                                })
                            ]
                        }));
                    }

                    // Rol: Administrador
                    if (roles.includes("Administrador")) {
                        tabItems.push(new sap.m.IconTabFilter({
                            text: "Administrador",
                            content: [
                                new sap.ui.layout.Grid({
                                    defaultSpan: "L3 M6 S12",
                                    content: [
                                        createTile("Proveedores", "monitorfacturasproveedores-display"),
                                        createTile("Orden de Compra", "monitorfacturasordendecompra-display"),
                                        createTile("Monitor Facturas", "monitorfacturasmonitorfacturas-display")
                                    ]
                                })
                            ]
                        }));
                    }

                    // Crear UI5 App con tabs filtrados por rol
                    new sap.m.App({
                        pages: [
                            new sap.m.Page({
                                title: "Panel de Aplicaciones - Monitor Facturas",
                                content: [
                                    new sap.m.IconTabBar({
                                        expandable: false,
                                        items: tabItems
                                    }),
                                    new sap.ui.core.HTML({
                                        content: '<iframe id="appFrame" title="Aplicación" src=""></iframe>'
                                    })
                                ]
                            })
                        ]
                    }).placeAt("content");
        });
    </script>
</head>
<body class="sapUiBody" id="content"></body>
</html>
